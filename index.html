<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>kepstin’s MagicISRC</title>
    <link rel="stylesheet" href="bootstrap.min.css">
<style>
#container {
  margin-top: 1rem;
}
</style>
<script type="text/javascript">

// Configuration

var mb_site = new URL("https://test.musicbrainz.org/");
var mb_ws2_base = new URL("ws/2/", mb_site);
var mb_oauth_base = new URL("oauth2/", mb_site);
var mb_oauth_redirect_uri = "https://magicisrc-beta.kepstin.ca/";
var mb_oauth_client_id = "sNuh2rVFO_RNUdNzj8wzMA";
var mb_oauth_client_secret = "_1KuzAcMHqb-5VRdRsa61Q"; // Not so secret after all, are you?

// Internal State

// Information about currently logged in user - auth token and user info
var login = {};
// ID of the release to operate on
var mbid = null;
// Set to false if MBID parsing fails
var mbid_valid = true;

// Simple JavaScript Templating
// John Resig - http://ejohn.org/ - MIT Licensed
(function(){
  var cache = {};
 
  this.tmpl = function tmpl(str, data){
    // Figure out if we're getting a template, or if we need to
    // load the template - and be sure to cache the result.
    var fn = !/\W/.test(str) ?
      cache[str] = cache[str] ||
        tmpl(document.getElementById(str).innerHTML) :
     
      // Generate a reusable function that will serve as a template
      // generator (and which will be cached).
      new Function("obj",
        "var p=[],print=function(){p.push.apply(p,arguments);};" +
       
        // Introduce the data as local variables using with(){}
        "with(obj){p.push('" +
       
        // Convert the template into pure JavaScript
        str
          .replace(/[\r\t\n]/g, " ")
          .split("<%").join("\t")
          .replace(/((^|%>)[^\t]*)'/g, "$1\r")
          .replace(/\t=(.*?)%>/g, "',$1,'")
          .split("\t").join("');")
          .split("%>").join("p.push('")
          .split("\r").join("\\'")
      + "');}return p.join('');");
   
    // Provide some basic currying to the user
    return data ? fn( data ) : fn;
  };
})();

(function() {
  var entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': '&quot;',
    "'": '&#39;',
    "/": '&#x2F;'
  };

  this.escapeHtml = function escapeHtml(string) {
    return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
    });
  };
})();

function bufferToHex(buffer) {
  return Array
    .from (new Uint8Array (buffer))
    .map (b => b.toString (16).padStart (2, "0"))
    .join ("");
}

function generateStateId() {
  var stateArray = new Uint8Array(16);
  window.crypto.getRandomValues(stateArray);
  return bufferToHex(stateArray);
}

var query = {};
var errors = [];

// Perform a navigation to a new state, represented by a set of URL search
// parameters. This pushes the new URL as a new history item, and then
// loads the page as if it was just navigated to.
function pushState(params) {
  var location = new URL(window.location.href);
  if (params == "") {
    location.search = "";
  } else {
    location.search = "?" + params;
  }
  window.history.pushState(null, "", location);
  onPopState();
}

function onPopState(event) {
  errors = [];
  console.log("New location: " + window.location);
  params = new URLSearchParams(window.location.search);
  loadState(params);
}

function loadState(params) {
  checkLogin();
  if (params.has("state") && (params.has("code") || params.has("error"))) {
    // This is the OAuth callback
    handleLoginCallback(params);
  } else {
    // Fallback: render index page
    renderIndex(params);
  }
}

function checkLogin() {
  login = JSON.parse(window.localStorage.getItem("mb_login"));

  // Ensure that login is always a hash
  if (!login) { login = {} }
  console.log("login", login);

  // Clear expired login credentials
  if (login.expires <= new Date().getTime()) {
    login = {};
    window.localStorage.removeItem("mb_login");
  }

  renderNavbar();
}

function doLogin() {
  var stateId = generateStateId();
  var state = {
    stateId: stateId,
    date: new Date().getTime(),
    params: new URL(window.location).searchParams.toString()
  };
  window.sessionStorage.setItem("mb_oauth_state", JSON.stringify(state));
  console.log("saved state:", state);

  var url = new URL("authorize", mb_oauth_base);
  var params = url.searchParams;
  params.set("response_type", "code");
  params.set("client_id", mb_oauth_client_id);
  params.set("redirect_uri", mb_oauth_redirect_uri);
  params.set("scope", "profile submit_isrc");
  params.set("state", stateId);

  window.location = url;
}

function handleLoginCallback(params) {
  var location = new URL(window.location.href);
  location.search = "";
  window.history.replaceState(null, "", location);

  renderLoginProgress();

  var stateId = params.get('state');
  var state = JSON.parse(window.sessionStorage.getItem("mb_oauth_state"));
  if (state["stateId"] != stateId) {
    return renderError("State returned from OAuth2 callback did not match saved state.");
  }

  var code = params.get('code');
  if (!code) {
    return renderError("OAuth2 callback did not return a code. Error: " + query['error']);
  }

  console.log("restored state:", state);

  // Fetch the auth token
  var url = new URL("token", mb_oauth_base);
  var data = new URLSearchParams();
  data.set("grant_type", "authorization_code");
  data.set("code", code);
  data.set("client_id", mb_oauth_client_id);
  data.set("client_secret", mb_oauth_client_secret);
  data.set("redirect_uri", mb_oauth_redirect_uri);
  window.fetch(url.href, { method: "POST", body: data })
    .then(response => { return response.json(); })
    .then(response => {
      login = {
        accessToken: response["access_token"],
        expires: new Date().getTime() + (response["expires_in"] * 1000)
      };
      window.localStorage.setItem("mb_login", JSON.stringify(login));
    })
    .catch(error => { renderError("When fetching OAuth2 token: " + error) })
    .then(doGetUserInfo)
    .then(() => {
      pushState(new URLSearchParams(state["params"]));
    });
}

function doGetUserInfo() {
  var url = new URL("userinfo", mb_oauth_base);
  return window.fetch(url.href, { headers: { "Authorization": "Bearer " + login["accessToken"] } })
    .then(response => { return response.json(); })
    .then(response => {
      login["userInfo"] = response;
      window.localStorage.setItem("mb_login", JSON.stringify(login));
    })
    .catch(error => { renderError("When fetching OAuth2 userinfo: " + error) });
}

function doLogout() {
  window.localStorage.removeItem("mb_login");
  onPopState();
}

function doSubmitMbid() {
  var mbid = document.getElementById("mbid").value;
  var params = new URLSearchParams(window.location.search);
  params.set("mbid", mbid);
  pushState(params);
}

function renderIndex(params) {
  var container = document.getElementById("container");
  container.innerHTML = tmpl("template_index", {
    mbid: params.get("mbid") || ""
  });
}

function renderNavbar() {
  var navbar = document.getElementById("navbar");
  navbar.innerHTML = tmpl("template_navbar", {login: login});
}

function renderLoginProgress() {
  document.getElementById("container").innerHTML = tmpl("template_login_progress", {});
}

function renderError(error) {
  document.getElementById("container").innerHTML = tmpl("template_error", {error: error});
}

</script>
<script type="text/x-ejs" id="template_index">
<form method="get" onsubmit="doSubmitMbid(); return false;">
  <div class="form-group">
    <label for="mbid">Enter a release MBID:</label>
    <div class="form-row">
      <div class="col">
        <input type="text" class="form-control form-control-lg<% if (!mbid_valid) { %> is-invalid <% } %>" id="mbid" value="<%= escapeHtml(mbid) %>">
        <div class="invalid-feedback">The provided value doesn’t appear to contain a release MBID</div>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-lg btn-primary">Load</button>
      </div>
    </div>
    <small class="form-text text-muted">
      You can also paste in a URL to a release page, or any string containing a release MBID.
    </small>
  </div>
</form>
</script>
<script type="text/x-ejs" id="template_navbar">
<span class="navbar-brand mr-auto">MagicISRC</span>
<% if (login.userInfo) { %>
  <span class="navbar-text" style="margin-right: 1em"><%= escapeHtml(login.userInfo.sub) %></span>
  <form class="form-inline">
    <button class="btn btn-outline-dark" type="button" onClick="doLogout(); return false;">Logout</button>
  </form>
<% } else { %>
  <form class="form-inline">
    <button class="btn btn-outline-dark" type="button" onClick="doLogin(); return false;">Login</button>
  </form>
<% } %>
</script>
<script type="text/x-ejs" id="template_login_progress">
<h2>Logging you in…</h2>
</script>
<script type="text/x-ejs" id="template_error">
<h2>A bad thing happened</h2>
<pre><%= escapeHtml("" + error) %></pre>
</script>
  </head>
  <body>
<nav class="navbar navbar-light bg-light">
  <div class="container" id="navbar">
    <span class="navbar-brand mr-auto">MagicISRC</span>
  </div>
</nav>
<div class="container" id="container">
<h1>kepstin’s MagicISRC Beta</h1>
<p>If you’re seeing this, you either have Javascript disabled, or I’ve gone and broken the page.</p>
</div>
<script type="text/javascript">
window.onpopstate = onPopState;
onPopState();
</script>
  </body>
</html>
